<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">
    <changeSet failOnError="true" author="Emeka" id="prep-1">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="prep_eligibility"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS prep_eligibility
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying(255),
                unique_id character varying,
                score integer,
                visit_date date,
                hiv_risk jsonb,
                sti_screening jsonb,
                drug_use_history jsonb,
                personal_hiv_risk_assessment jsonb,
                sex_partner_risk jsonb,
                person_uuid character varying(255),
                sex_partner character varying(255),
                counseling_type character varying(255),
                first_time_visit boolean,
                num_children_less_than_five character varying(255),
                num_wives integer,
                target_group character varying(255),
                extra jsonb,
                facility_id bigint NOT NULL,
                archived integer NOT NULL,
                created_by character varying(255) NOT NULL,
                date_created timestamp without time zone NOT NULL,
                modified_by character varying(255),
                date_modified timestamp without time zone,
                CONSTRAINT pk_prep_eligibility PRIMARY KEY (id),
                CONSTRAINT uc_prep_eligibility_uuid UNIQUE (uuid),
                CONSTRAINT fk_prep_eligibility_on_person_uuid FOREIGN KEY (person_uuid)
                REFERENCES patient_person (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                NOT VALID,
                CONSTRAINT fk_prep_eligibility_on_target_group_fk FOREIGN KEY (target_group)
                REFERENCES base_application_codeset (code) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                )
        </sql>
    </changeSet>
    <changeSet failOnError="true" author="Emeka" id="prep-2">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="prep_enrollment"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS prep_enrollment
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                unique_id character varying(255),
                target_group character varying(255),
                uuid character varying(255) NOT NULL,
                date_started date,
                person_uuid character varying(255) NOT NULL,
                visit_uuid character varying(255),
                extra jsonb,
                facility_id bigint NOT NULL,
                prep_eligibility_uuid character varying,
                status character varying,
                date_enrolled date,
                date_referred date,
                risk_type character varying,
                supporter_phone character varying,
                supporter_name character varying,
                supporter_relationship_type character varying,
                anc_unique_art_no character varying,
                hiv_testing_point character varying,
                date_last_hiv_negative_test date,
                archived integer NOT NULL,
                created_by character varying(255) NOT NULL,
                date_created timestamp without time zone NOT NULL,
                modified_by character varying(255),
                date_modified timestamp without time zone,
                CONSTRAINT pk_prep_enrollment PRIMARY KEY (id),
                CONSTRAINT prep_eligibility_uuid UNIQUE (prep_eligibility_uuid),
                CONSTRAINT uc_prep_enrollment_uuid UNIQUE (uuid),
                CONSTRAINT fk_prep_eligibility_uuid FOREIGN KEY (prep_eligibility_uuid)
                REFERENCES prep_eligibility (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                                       NOT VALID,
                CONSTRAINT fk_prep_enrollment_on_person_uuid FOREIGN KEY (person_uuid)
                REFERENCES patient_person (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT fk_prep_enrollment_on_visit_uuid FOREIGN KEY (visit_uuid)
                REFERENCES patient_visit (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT fk_risk_type FOREIGN KEY (risk_type)
                REFERENCES base_application_codeset (code) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                                       NOT VALID
                )
        </sql>
    </changeSet>
    <changeSet failOnError="true" author="Emeka" id="prep-3">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="prep_clinic"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS prep_clinic
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                weight double precision,
                height double precision,
                pulse double precision,
                temperature double precision,
                respiratory_rate double precision,
                systolic double precision,
                diastolic double precision,
                adherence_level character varying(255),
                sti_screening boolean,
                date_prep_start date,
                date_prep_given date,
                prep_given character varying(255),
                other_drugs character varying(255),
                hiv_test_result character varying(255),
                encounter_date date,
                is_commencement boolean,
                prep_enrollment_uuid character varying(255),
                uuid character varying(255) NOT NULL,
                regimen_id bigint,
                regimen_type_id bigint,
                duration integer,
                vital_sign_uuid character varying(255),
                person_uuid character varying(255),
                visit_uuid character varying(255),
                next_appointment date,
                why boolean,
                datePrepGiven date,
                urinalysis jsonb,
                hepatitis jsonb,
                syphilis jsonb,
                other_tests_done jsonb,
                syndromic_sti_screening jsonb,
                date_initial_adherence_counseling date,
                date_referred date,
                referred boolean,
                urinalysis_result character varying,
                pregnant character varying,
                facility_id bigint,
                extra jsonb,
                risk_reduction_services character varying,
                noted_side_effects character varying,
                created_by character varying(255) NOT NULL,
                date_created timestamp without time zone NOT NULL,
                modified_by character varying(255),
                date_modified timestamp without time zone,
                archived integer,
                CONSTRAINT pk_prep_clinical PRIMARY KEY (id),
                CONSTRAINT uc_prep_clinical_uuid UNIQUE (uuid),
                CONSTRAINT fk_prep_clinical_on_person_uuid FOREIGN KEY (person_uuid)
                REFERENCES patient_person (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT fk_prep_clinical_on_prep_enrollment_uuid FOREIGN KEY (prep_enrollment_uuid)
                REFERENCES prep_enrollment (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT fk_prep_clinical_on_visit_uuid FOREIGN KEY (visit_uuid)
                REFERENCES patient_visit (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION,
                CONSTRAINT fk_prep_clinical_on_vital_sign_uuid FOREIGN KEY (vital_sign_uuid)
                REFERENCES triage_vital_sign (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                )
        </sql>
    </changeSet>
    <changeSet failOnError="true" author="Emeka" id="prep-4">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="prep_interruption"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS prep_interruption
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                uuid character varying(255) NOT NULL,
                person_uuid character varying(255) NOT NULL,
                prep_enrollment_uuid character varying(255),
                interruption_type character varying(255),
                interruption_date date,
                date_client_died date,
                cause_of_death character varying(255),
                source_of_death_info character varying(255),
                date_client_referred_out date,
                facility_referred_to character varying(255),
                interruption_reason character varying(255),
                extra jsonb,
                facility_id bigint NOT NULL,
                archived integer NOT NULL,
                created_by character varying(255) NOT NULL,
                date_created timestamp without time zone NOT NULL,
                modified_by character varying(255),
                date_sero_converted date,
                date_restart_placed_back_medication date,
                link_to_art boolean,
                encounter_date date,
                date_modified timestamp without time zone,
                CONSTRAINT pk_prep_interruption PRIMARY KEY (id),
                CONSTRAINT uc_prep_interruption_uuid UNIQUE (uuid),
                CONSTRAINT fk_prep_enrollment_uuid FOREIGN KEY (prep_enrollment_uuid)
                REFERENCES prep_enrollment (uuid) MATCH SIMPLE
                                       ON UPDATE NO ACTION
                                       ON DELETE NO ACTION
                )
        </sql>
    </changeSet>
    <changeSet failOnError="true" author="Emeka" id="prep-5">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="prep_regimen"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE IF NOT EXISTS prep_regimen
            (
                id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
                regimen character varying,
                composition character varying,
                description character varying,
                archived integer,
                code character varying,
                CONSTRAINT prep_id_pk PRIMARY KEY (id),
                CONSTRAINT unique_prep_regimen_code UNIQUE (code)
                )
        </sql>
    </changeSet>
</databaseChangeLog>